#!/usr/bin/env ruby

$script_path = File.dirname(__FILE__)

$dotfiles = [
  "tmux.conf",
  "vimrc",
  "gitconfig",
  "aliases"
]

def action(title, command)
  print title

  `#{command}`

  mark = $?.exitstatus == 0 ? "\e[32m✓\e[0m" : "\e[31m✗\e[0m"

  puts " #{mark}"
end

def create_base_dirs
  ["~/bin", "~/code"].each do |dir|
    action "Creating #{dir}", "mkdir -p #{dir}"
  end
end

def backup
  file_paths = $dotfiles.map { |file| "~/.#{file}" } .select { |file| `test -f #{file}` && $?.exitstatus == 0 }

  file_paths.each do |file|
    action "Creating backup #{file}.backup", "mv #{file} #{file}.backup"
  end
end

def update_dotfiles
  path_pairs = $dotfiles.map { |file| ["#{$script_path}/#{file}", "~/.#{file}"] }

  path_pairs.each do |(local_path, system_path)|
    action "Updating #{system_path}", "cp #{local_path} #{system_path}"
  end
end

backup

puts "\n"
create_base_dirs

puts "\n"
update_dotfiles

puts "\n"
action "Installing 'gh-pr'", "curl -sL 'https://raw.githubusercontent.com/rastasheep/dotfiles/master/bin/gh-pr' -o ~/bin/gh-pr && chmod +x ~/bin/gh-pr"

puts "\n"
action "Install shell aliases", "grep '~/.aliases' ~/.zshrc || echo 'source ~/.aliases' >> ~/.zshrc"

puts "\n"
puts "Dotfiles updated"
